<!DOCTYPE html>
<html lang="hr">

<head>
    <meta charset="UTF-8" />
    <title>Magnolya Salon</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body {
            background-color: #ffecfa;
            color: black;
        }

        .accent-bg {
            background-color: #8c5778 !important;
            color: black !important;
        }

        .table thead {
            background-color: #6c3f5a;
            color: black;
        }

        .form-control,
        .form-select {
            background-color: #fff;
            color: black;
        }

        button {
            background-color: #8c5778;
            color: black;
            font-weight: bold;
            border: none;
        }

        button:hover {
            background-color: #6c3f5a;
            color: black;
        }

        .sortable {
            cursor: pointer;
            text-decoration: underline;
        }
    </style>
</head>

<body class="p-4">
    <div class="container">

        <h1 class="mb-4">Dodaj rezervaciju</h1>
        <form id="rezervacijaForm" class="p-3 accent-bg rounded mb-5">
            <div class="mb-3">
                <label class="form-label">Prezime:</label>
                <input type="text" name="prezime" class="form-control" required>
            </div>
            <div class="mb-3">
                <label class="form-label">Kontakt:</label>
                <input type="text" name="kontakt" class="form-control" required>
            </div>
            <div class="row mb-3">
                <div class="col">
                    <label class="form-label">Datum:</label>
                    <input type="date" name="datum" class="form-control" required>
                </div>
                <div class="col">
                    <label class="form-label">Vrijeme:</label>
                    <input type="time" name="vrijeme" class="form-control" required>
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">Usluga:</label>
                <select name="usluga" id="uslugaSelect" class="form-select" required></select>
            </div>
            <div class="mb-3">
                <label class="form-label">Djelatnik:</label>
                <input type="text" name="djelatnik" class="form-control" required>
            </div>
            <div class="mb-3">
                <label class="form-label">Napomena:</label>
                <textarea name="napomena" class="form-control"></textarea>
            </div>
            <button type="submit" class="btn btn-primary w-100">Dodaj rezervaciju</button>
        </form>

        <h2 class="mb-3">Dodaj uslugu</h2>
        <form id="uslugaForm" class="p-3 accent-bg rounded mb-5">
            <div class="mb-3">
                <label class="form-label">Naziv usluge:</label>
                <input type="text" name="naziv" class="form-control" required>
            </div>
            <div class="mb-3">
                <label class="form-label">Vrsta usluge:</label>
                <input type="text" name="vrsta" class="form-control" required>
            </div>
            <div class="mb-3">
                <label class="form-label">Trajanje (min):</label>
                <input type="number" name="trajanje" class="form-control" required>
            </div>
            <div class="mb-3">
                <label class="form-label">Cijena (€):</label>
                <input type="number" name="cijena" class="form-control" required>
            </div>
            <button type="submit" class="btn btn-primary w-100">Dodaj uslugu</button>
        </form>

        <div class="d-flex align-items-center justify-content-between mb-2">
            <h1 class="mb-0">Rezervacije</h1>
            <!-- Kontrole za sortiranje -->
            <div class="d-flex gap-2 align-items-center">
                <label for="sortSelect" class="me-1">Sortiraj po datumu:</label>
                <select id="sortSelect" class="form-select form-select-sm" style="width:auto;">
                    <option value="asc" selected>Uzlazno (najranije prvo)</option>
                    <option value="desc">Silazno (najkasnije prvo)</option>
                </select>
                <button id="applySortBtn" class="btn btn-sm">Primijeni</button>
            </div>
        </div>

        <div class="table-responsive">
            <table id="rezervacijeTable" class="table table-striped table-bordered">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Prezime</th>
                        <th>Kontakt</th>
                        <th class="sortable" id="thDatum">Datum</th>
                        <th>Vrijeme</th>
                        <th>Usluga</th>
                        <th>Djelatnik</th>
                        <th>Napomena</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

    </div>

    <script>
        let currentSort = 'asc'; // 'asc' ili 'desc'

        function isoDatePart(dtIso) {
            // Očekuje ISO string, npr "2025-08-20T00:00:00"
            return dtIso.split('T')[0];
        }
        function timePart(dtIso) {
            // "2025-08-20T14:30:00" -> "14:30"
            return dtIso.split('T')[1]?.slice(0, 5) || '';
        }

        async function loadUsluge() {
            const res = await fetch("/usluge");
            const data = await res.json();
            const select = document.getElementById("uslugaSelect");
            select.innerHTML = "";
            data.forEach(u => {
                const opt = document.createElement("option");
                opt.value = u.id_usluge;
                opt.textContent = `${u.naziv_usluge} (${u.cijena}€)`;
                select.appendChild(opt);
            });
        }

        async function loadRezervacije(sorted = true) {
            let url = "/rezervacije";
            if (sorted) {
                const descending = currentSort === 'desc';
                url = `/rezervacije/sortirane?descending=${descending}`;
            }
            const res = await fetch(url);
            const data = await res.json();

            const tbody = document.querySelector("#rezervacijeTable tbody");
            tbody.innerHTML = "";
            data.forEach(rez => {
                const row = document.createElement("tr");
                row.innerHTML = `
      <td>${rez.id_rezervacije}</td>
      <td>${rez.prezime_osobe}</td>
      <td>${rez.kontakt}</td>
      <td>${isoDatePart(rez.datum_termina)}</td>
      <td>${timePart(rez.vrijeme_termina)}</td>
      <td>${rez.usluga ? rez.usluga.naziv_usluge : "N/A"}</td>
      <td>${rez.djelatnik}</td>
      <td>${rez.napomena || ""}</td>
    `;
                tbody.appendChild(row);
            });
        }

        document.getElementById("rezervacijaForm").addEventListener("submit", async function (e) {
            e.preventDefault();
            const f = new FormData(this);
            const payload = {
                prezime_osobe: f.get("prezime"),
                kontakt: f.get("kontakt"),
                datum_termina: f.get("datum"),
                vrijeme_termina: f.get("vrijeme"),
                djelatnik: f.get("djelatnik"),
                napomena: f.get("napomena"),
                id_usluge: parseInt(f.get("usluga"))
            };
            const res = await fetch("/rezervacije", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });
            if (res.ok) {
                this.reset();
                await loadRezervacije(true);
            } else {
                const txt = await res.text();
                alert("Greška kod spremanja rezervacije!\n" + txt);
            }
        });

        document.getElementById("uslugaForm").addEventListener("submit", async function (e) {
            e.preventDefault();
            const f = new FormData(this);
            const payload = {
                naziv_usluge: f.get("naziv"),
                vrsta_usluge: f.get("vrsta"),
                trajanje: parseInt(f.get("trajanje")),
                cijena: parseInt(f.get("cijena"))
            };
            const res = await fetch("/usluge", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });
            if (res.ok) {
                this.reset();
                await loadUsluge();
                alert("Usluga dodana!");
            } else {
                const txt = await res.text();
                alert("Greška kod dodavanja usluge!\n" + txt);
            }
        });

        // Dropdown “Primijeni”
        document.getElementById("applySortBtn").addEventListener("click", async (e) => {
            e.preventDefault();
            const sel = document.getElementById("sortSelect");
            currentSort = sel.value; // 'asc' ili 'desc'
            await loadRezervacije(true);
        });

        // Klik na zaglavlje “Datum” – toggla smjer
        document.getElementById("thDatum").addEventListener("click", async () => {
            currentSort = (currentSort === 'asc') ? 'desc' : 'asc';
            document.getElementById("sortSelect").value = currentSort;
            await loadRezervacije(true);
        });

        // inicijalno učitavanje
        loadUsluge();
        loadRezervacije(true);
    </script>
</body>

</html>